{
  "experiments": [
    {
      "experimentID": "e91d3b90-bfa6-4f83-9f69-72a1723948d2",
      "name": "lqekn",
      "createdAt": "2025-12-04T20:41:47.751Z",
      "updatedAt": "2025-12-04T20:41:47.751Z"
    }
  ],
  "trials": [
    {
      "experimentID": "e91d3b90-bfa6-4f83-9f69-72a1723948d2",
      "data": {
        "trials": [
          {
            "id": 1765473193557,
            "type": "Trial",
            "name": "New Trial",
            "parameters": {
              "includesExtensions": true,
              "extensionType": ""
            },
            "trialCode": "\n    const test_stimuli_New_Trial = [{components: [],\nresponse_components: [{ type: \"SurveyComponent\", coordinates: {\"x\":0,\"y\":0}, width: 200, height: 50, survey_json: {\"title\":\"My Survey\",\"elements\":[{\"type\":\"imagepicker\",\"name\":\"question1\",\"title\":\"Question 1\",\"isRequired\":false,\"imageLink\":\"img/armadillo.png\",\"altText\":\"kmklml,lm\",\"description\":\"lkmñkmñk\",\"imageFit\":\"cover\",\"contentMode\":\"auto\",\"choices\":[{\"value\":\"\",\"text\":\"\",\"imageLink\":\"\"}]},{\"type\":\"image\",\"name\":\"\",\"title\":\"\",\"isRequired\":false,\"imageLink\":\"img/armadillo.png\"}]} }],\nstimuli_duration: undefined,\ntrial_duration: undefined,\nresponse_ends_trial: undefined,\nresponses: [{ type: \"SurveyComponent\", coordinates: {\"x\":0,\"y\":0}, width: 200, height: 50, survey_json: {\"title\":\"My Survey\",\"elements\":[{\"type\":\"imagepicker\",\"name\":\"question1\",\"title\":\"Question 1\",\"isRequired\":false,\"imageLink\":\"img/armadillo.png\",\"altText\":\"kmklml,lm\",\"description\":\"lkmñkmñk\",\"imageFit\":\"cover\",\"contentMode\":\"auto\",\"choices\":[{\"value\":\"\",\"text\":\"\",\"imageLink\":\"\"}]},{\"type\":\"image\",\"name\":\"\",\"title\":\"\",\"isRequired\":false,\"imageLink\":\"img/armadillo.png\"}]} }]}];\n    const New_Trial_timeline = {\n    type: DynamicPlugin, components: jsPsych.timelineVariable(\"components\"),\nresponse_components: jsPsych.timelineVariable(\"response_components\"),\nstimuli_duration: jsPsych.timelineVariable(\"stimuli_duration\"),\ntrial_duration: jsPsych.timelineVariable(\"trial_duration\"),\nresponse_ends_trial: jsPsych.timelineVariable(\"response_ends_trial\"),\n      data: {\n        stimulus: \"stimulus\",\nresponse: \"response\",\nrt: \"rt\",\n        trial_id: 1765473193557,\n        \n        \n      },\n    on_start: function(trial) {\n      // First, evaluate and apply params override conditions (if any)\n      \n      // Then apply custom parameters from branching conditions (higher priority)\n      \n      // For trials outside loops, use window.branchCustomParameters\n      if (window.branchCustomParameters && typeof window.branchCustomParameters === 'object') {\n        Object.entries(window.branchCustomParameters).forEach(([key, param]) => {\n          if (param && param.source !== 'none') {\n            // Parse key to check if it's a nested survey question\n            const parts = key.split('::');\n            \n            if (parts.length === 4) {\n              // Format: fieldType::componentName::survey_json::questionName\n              const [fieldType, componentName, propName, questionName] = parts;\n              \n              if (fieldType && componentName && propName === 'survey_json' && questionName) {\n                // Find the component by name in the field array\n                const fieldArray = trial[fieldType];\n                if (Array.isArray(fieldArray)) {\n                  const compIndex = fieldArray.findIndex(c => c.name === componentName);\n                  if (compIndex !== -1 && fieldArray[compIndex].survey_json) {\n                    // Find the question in survey_json.elements\n                    const elements = fieldArray[compIndex].survey_json.elements || [];\n                    const questionIndex = elements.findIndex(q => q.name === questionName);\n                    \n                    if (questionIndex !== -1) {\n                      // Apply the override value (from typed or csv)\n                      let valueToSet;\n                      if (param.source === 'typed') {\n                        valueToSet = String(param.value); // Convert to string for SurveyJS\n                      } else if (param.source === 'csv') {\n                        valueToSet = String(trial[param.value]); // Get from CSV column and convert to string\n                      }\n                      \n                      if (valueToSet !== undefined && valueToSet !== null) {\n                        fieldArray[compIndex].survey_json.elements[questionIndex].defaultValue = valueToSet;\n                      }\n                    }\n                  }\n                }\n              }\n            } else {\n              // Normal parameter (not nested survey question)\n              if (param.source === 'typed' && param.value !== undefined && param.value !== null) {\n                trial[key] = param.value;\n              } else if (param.source === 'csv' && param.value !== undefined && param.value !== null) {\n                trial[key] = trial[param.value];\n              }\n            }\n          }\n        });\n        // Clear the custom parameters after applying them\n        window.branchCustomParameters = null;\n      }\n      \n    },\n    \n    on_finish: function(data) {\n      // Este trial no tiene branches ni repeat conditions, es un trial terminal\n      // Si llegamos aquí después de un branching, terminar el experimento\n      if (window.branchingActive) {\n        jsPsych.abortExperiment('', {});\n      }\n    },\n    };\n    const New_Trial_procedure = {\n    timeline: \n    [New_Trial_timeline],\n    timeline_variables: test_stimuli_New_Trial,\n    conditional_function: function() {\n      const currentId = 1765473193557;\n      \n      // Verificar si hay un trial objetivo guardado en localStorage (para repeat/jump)\n      const jumpToTrial = localStorage.getItem('jsPsych_jumpToTrial');\n      if (jumpToTrial) {\n        if (String(currentId) === String(jumpToTrial)) {\n          // Encontramos el trial objetivo para repeat/jump\n          console.log('Repeat/jump: Found target trial', currentId);\n          localStorage.removeItem('jsPsych_jumpToTrial');\n          return true;\n        }\n        // No es el objetivo, saltar\n        console.log('Repeat/jump: Skipping trial', currentId);\n        return false;\n      }\n      \n      // Si skipRemaining está activo (branching normal), verificar si este es el trial objetivo\n      if (window.skipRemaining) {\n        if (String(currentId) === String(window.nextTrialId)) {\n          // Encontramos el trial objetivo\n          window.skipRemaining = false;\n          window.nextTrialId = null;\n          return true;\n        }\n        // No es el objetivo, saltar\n        return false;\n      }\n      \n      return true;\n    },\n    \n    };\n    timeline.push(New_Trial_procedure);\n  ",
            "plugin": "plugin-dynamic",
            "columnMapping": {
              "response_components": {
                "source": "typed",
                "value": [
                  {
                    "type": "SurveyComponent",
                    "coordinates": {
                      "x": 0,
                      "y": 0
                    },
                    "width": 200,
                    "height": 50,
                    "survey_json": {
                      "title": "My Survey",
                      "elements": [
                        {
                          "type": "imagepicker",
                          "name": "question1",
                          "title": "Question 1",
                          "isRequired": false,
                          "imageLink": "img/armadillo.png",
                          "altText": "kmklml,lm",
                          "description": "lkmñkmñk",
                          "imageFit": "cover",
                          "contentMode": "auto",
                          "choices": [
                            {
                              "value": "",
                              "text": "",
                              "imageLink": ""
                            }
                          ]
                        },
                        {
                          "type": "image",
                          "name": "",
                          "title": "",
                          "isRequired": false,
                          "imageLink": "img/armadillo.png"
                        }
                      ]
                    },
                    "__configMetadata": {
                      "survey_json": {
                        "source": "typed",
                        "value": {
                          "title": "My Survey",
                          "elements": [
                            {
                              "type": "imagepicker",
                              "name": "question1",
                              "title": "Question 1",
                              "isRequired": false,
                              "imageLink": "img/armadillo.png",
                              "altText": "kmklml,lm",
                              "description": "lkmñkmñk",
                              "imageFit": "cover",
                              "contentMode": "auto",
                              "choices": [
                                {
                                  "value": "",
                                  "text": "",
                                  "imageLink": ""
                                }
                              ]
                            },
                            {
                              "type": "image",
                              "name": "",
                              "title": "",
                              "isRequired": false,
                              "imageLink": "img/armadillo.png"
                            }
                          ]
                        }
                      }
                    }
                  }
                ]
              }
            },
            "csvJson": [],
            "csvColumns": [],
            "orders": false,
            "orderColumns": [],
            "stimuliOrders": [],
            "categories": false,
            "categoryColumn": ""
          }
        ]
      },
      "createdAt": "2025-12-04T20:41:49.093Z",
      "updatedAt": "2025-12-11T19:01:36.457Z"
    }
  ],
  "configs": [
    {
      "experimentID": "e91d3b90-bfa6-4f83-9f69-72a1723948d2",
      "data": {
        "generatedCode": "\n  // --- Recolectar metadata del sistema ---\n  const getMetadata = () => {\n    const ua = navigator.userAgent;\n    let browserName = 'Unknown';\n    let browserVersion = 'Unknown';\n    \n    if (ua.indexOf('Firefox') > -1) {\n      browserName = 'Firefox';\n      browserVersion = ua.match(/Firefox\\/(\\d+\\.\\d+)/)?.[1] || 'Unknown';\n    } else if (ua.indexOf('Chrome') > -1) {\n      browserName = 'Chrome';\n      browserVersion = ua.match(/Chrome\\/(\\d+\\.\\d+)/)?.[1] || 'Unknown';\n    } else if (ua.indexOf('Safari') > -1) {\n      browserName = 'Safari';\n      browserVersion = ua.match(/Version\\/(\\d+\\.\\d+)/)?.[1] || 'Unknown';\n    } else if (ua.indexOf('Edg') > -1) {\n      browserName = 'Edge';\n      browserVersion = ua.match(/Edg\\/(\\d+\\.\\d+)/)?.[1] || 'Unknown';\n    }\n    \n    let osName = 'Unknown';\n    if (ua.indexOf('Win') > -1) osName = 'Windows';\n    else if (ua.indexOf('Mac') > -1) osName = 'macOS';\n    else if (ua.indexOf('Linux') > -1) osName = 'Linux';\n    else if (ua.indexOf('Android') > -1) osName = 'Android';\n    else if (ua.indexOf('iOS') > -1) osName = 'iOS';\n    \n    return {\n      browser: browserName,\n      browserVersion: browserVersion,\n      os: osName,\n      screenWidth: window.screen.width,\n      screenHeight: window.screen.height,\n      screenResolution: `${window.screen.width}x${window.screen.height}`,\n      viewportWidth: window.innerWidth,\n      viewportHeight: window.innerHeight,\n      language: navigator.language,\n      userAgent: ua,\n      startedAt: new Date().toISOString()\n    };\n  };\n  \n  const metadata = getMetadata();\n\n  // --- Firebase config ---\n  const firebaseConfig = {\n    apiKey: \"AIzaSyBEbJ-uGKzsaf2u24KPamBPVZrUmvhFk-Q\",\n    authDomain: \"test-e4cf9.firebaseapp.com\",\n    databaseURL: \"http://localhost:9000?ns=test-e4cf9\",\n    projectId: \"test-e4cf9\",\n    storageBucket: \"test-e4cf9.firebasestorage.app\",\n    messagingSenderId: \"414213417080\",\n    appId: \"1:414213417080:web:98607c621a54d07656e58d\"\n  };\n\n  // --- Cargar Firebase SDK ---\n  if (typeof window.firebase === 'undefined') {\n    const script = document.createElement('script');\n    script.src = 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js';\n    script.onload = () => {\n      const dbScript = document.createElement('script');\n      dbScript.src = 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js';\n      dbScript.onload = () => { window._firebaseReady = true; };\n      document.head.appendChild(dbScript);\n    };\n    document.head.appendChild(script);\n  } else {\n    window._firebaseReady = true;\n  }\n\n  function waitForFirebase() {\n    return new Promise(resolve => {\n      if (window._firebaseReady) return resolve();\n      const interval = setInterval(() => {\n        if (window._firebaseReady) {\n          clearInterval(interval);\n          resolve();\n        }\n      }, 50);\n    });\n  }\n\n \n  const userStr = null;\n\n  const Uid = userStr.uid\n\n  const trialSessionId =\n    \"online_\" + (crypto.randomUUID\n      ? crypto.randomUUID()\n      : Math.random().toString(36).slice(2, 10));\n\n  let participantNumber;\n\n  async function saveSession(trialSessionId) {\n    try {\n      const res = await fetch(\"http://localhost:5001/test-e4cf9/us-central1/apiData\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\", Accept: \"*/*\" },\n        body: JSON.stringify({\n          experimentID: \"e91d3b90-bfa6-4f83-9f69-72a1723948d2\",\n          experimentName: \"lqekn\", \n          sessionId: trialSessionId,\n          storage: \"drive\",\n          uid: Uid\n        }),\n      });\n      \n      console.log('Response status:', res.status);\n      \n      if (!res.ok) {\n        const errorText = await res.text();\n        console.error('Error creating session:', errorText);\n        throw new Error(`Failed to create session: ${res.status} - ${errorText}`);\n      }\n      \n      const result = await res.json();\n      console.log('Session created successfully:', result);\n      \n      if (!result.success) {\n        if (result.message?.includes(\"INVALID_GOOGLE_DRIVE_TOKEN\") || result.message?.includes(\"Invalid Google Drive token\")) {\n          alert(\"Warning: Google Drive token not found or invalid. Please reconnect your Drive account in Settings.\");\n        } else if (result.message?.includes(\"INVALID_DROPBOX_TOKEN\") || result.message?.includes(\"Invalid Dropbox token\")) {\n          alert(\"Warning: Dropbox token not found or invalid. Please reconnect your Dropbox account in Settings.\");\n        }\n        throw new Error(result.message || 'Failed to create session');\n      }\n      \n      participantNumber = result.participantNumber;\n      return participantNumber;\n    } catch (error) {\n      console.error('Error in saveSession:', error);\n      alert('Error creating session: ' + error.message);\n      throw error;\n    }\n  }\n\n  (async () => {\n    // Limpiar el localStorage de valores de sesiones anteriores\n    localStorage.removeItem('jsPsych_jumpToTrial');\n    \n    // Esperar e inicializar Firebase\n    await waitForFirebase();\n    if (!window.firebase.apps.length) {\n      window.firebase.initializeApp(firebaseConfig);\n    }\n    const db = window.firebase.database();\n\n    participantNumber = await saveSession(trialSessionId);\n\n    if (typeof participantNumber !== \"number\" || isNaN(participantNumber)) {\n      alert(\"The participant number is not assigned. Please, wait.\");\n      throw new Error(\"participantNumber not assigned\");\n    }\n\n    // --- Configurar onDisconnect para finalizar sesión automáticamente ---\n    const sessionRef = db.ref('sessions/e91d3b90-bfa6-4f83-9f69-72a1723948d2/' + trialSessionId);\n    await sessionRef.set({\n      connected: true,\n      experimentID: 'e91d3b90-bfa6-4f83-9f69-72a1723948d2',\n      sessionId: trialSessionId,\n      startedAt: window.firebase.database.ServerValue.TIMESTAMP,\n      storage: 'drive',\n      state: 'initiated',\n      lastUpdate: window.firebase.database.ServerValue.TIMESTAMP,\n      metadata: metadata\n    });\n    \n    // Guardar metadata en db.json local también (para persistencia)\n    fetch('/api/save-online-session-metadata/e91d3b90-bfa6-4f83-9f69-72a1723948d2', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        sessionId: trialSessionId,\n        metadata: metadata,\n        state: 'initiated'\n      })\n    }).catch(err => console.warn('Could not save metadata to local db:', err));\n    \n    // Cuando se desconecte, marcar para que el backend finalice la sesión\n    // Incluir needsFinalization para que se procesen los datos en caso de desconexión\n    sessionRef.onDisconnect().update({\n      connected: false,\n      needsFinalization: true,\n      disconnectedAt: window.firebase.database.ServerValue.TIMESTAMP,\n      storage: 'drive'\n    });\n\n    // --- Branching logic functions (outside initJsPsych for timeline access) ---\n    window.nextTrialId = null;\n    window.skipRemaining = false;\n    window.branchingActive = false;\n    window.branchCustomParameters = null; // Store custom parameters for the next trial\n\n    const evaluateCondition = (trialData, condition) => {\n      // All rules in a condition must be true (AND logic)\n      return condition.rules.every(rule => {\n        let propValue;\n        \n        // For dynamic plugins, handle nested structure\n        if (rule.fieldType && rule.componentIdx !== undefined && rule.componentIdx !== \"\") {\n          // Dynamic plugin structure: fieldType -> componentIdx -> prop\n          // Note: response_components in the builder becomes \"response\" in the actual trial data\n          const actualFieldName = rule.fieldType === 'response_components' ? 'response' : rule.fieldType;\n          const fieldArray = trialData[actualFieldName];\n          if (!Array.isArray(fieldArray)) {\n            console.warn('Field array not found for fieldType:', rule.fieldType, 'actual field:', actualFieldName);\n            return false;\n          }\n          \n          // componentIdx is the component name, not a numeric index\n          const component = fieldArray.find(c => c.name === rule.componentIdx);\n          if (!component) {\n            console.warn('Component not found with name:', rule.componentIdx);\n            return false;\n          }\n          \n          // Get the property value from the component\n          // For SurveyComponent, the response structure is different\n          // The prop is actually a question name inside component.response\n          if (component.type === \"SurveyComponent\" && component.response && typeof component.response === 'object') {\n            // The prop (e.g., \"question1\") is a key inside component.response\n            if (component.response[rule.prop] !== undefined) {\n              propValue = component.response[rule.prop];\n            } else {\n              return false;\n            }\n          } else {\n            // For other components, check direct properties\n            if (rule.prop === \"response\" && component.response !== undefined) {\n              propValue = component.response;\n            } else if (component[rule.prop] !== undefined) {\n              propValue = component[rule.prop];\n            } else {\n              return false;\n            }\n          }\n        } else {\n          // Normal plugin structure\n          propValue = trialData[rule.prop];\n        }\n        \n        const compareValue = rule.value;\n        \n        // Handle array responses (multi-select or single-select returned as array)\n        if (Array.isArray(propValue)) {\n          const matches = propValue.includes(compareValue) || propValue.includes(String(compareValue));\n          switch (rule.op) {\n            case '==':\n              return matches;\n            case '!=':\n              return !matches;\n            default:\n              return false;\n          }\n        }\n        \n        // Convert values for comparison (for non-array values)\n        const numPropValue = parseFloat(propValue);\n        const numCompareValue = parseFloat(compareValue);\n        const isNumeric = !isNaN(numPropValue) && !isNaN(numCompareValue);\n        \n        switch (rule.op) {\n          case '==':\n            return isNumeric ? numPropValue === numCompareValue : propValue == compareValue;\n          case '!=':\n            return isNumeric ? numPropValue !== numCompareValue : propValue != compareValue;\n          case '>':\n            return isNumeric && numPropValue > numCompareValue;\n          case '<':\n            return isNumeric && numPropValue < numCompareValue;\n          case '>=':\n            return isNumeric && numPropValue >= numCompareValue;\n          case '<=':\n            return isNumeric && numPropValue <= numCompareValue;\n          default:\n            return false;\n        }\n      });\n    };\n    \n    const getNextTrialId = (lastTrialData) => {\n      if (!lastTrialData || !lastTrialData.trials || !lastTrialData.trials[0]) {\n        return null;\n      }\n      \n      const trial = lastTrialData.trials[0];\n      \n      // Check if trial/loop has branches\n      if (!Array.isArray(trial.branches) || trial.branches.length === 0) {\n        return null;\n      }\n      \n      // Check if there are conditions to evaluate\n      const hasBranchConditions = Array.isArray(trial.branchConditions) && trial.branchConditions.length > 0;\n      \n      // Check if any condition has customParameters\n      const hasCustomParameters = hasBranchConditions && \n        trial.branchConditions.flat().some(condition => \n          condition && condition.customParameters && \n          Object.keys(condition.customParameters).length > 0\n        );\n      \n      // If there are no conditions AND no custom parameters, auto-branch to first branch\n      if (!hasBranchConditions && !hasCustomParameters) {\n        console.log('No conditions or custom parameters defined, auto-branching to first branch:', trial.branches[0]);\n        return trial.branches[0];\n      }\n      \n      // If there are no conditions but there ARE custom parameters, we can't auto-branch\n      // We need to evaluate conditions to know which customParameters to use\n      if (!hasBranchConditions && hasCustomParameters) {\n        console.log('Custom parameters exist but no conditions, cannot auto-branch');\n        return null;\n      }\n      \n      // If there ARE conditions, evaluate them (regardless of how many branches there are)\n      // branchConditions is an array of arrays, flatten it first\n      const conditions = trial.branchConditions.flat();\n      \n      // Evaluate each condition (OR logic between conditions)\n      for (const condition of conditions) {\n        if (!condition || !condition.rules) {\n          console.warn('Invalid condition structure:', condition);\n          continue;\n        }\n        \n        if (evaluateCondition(trial, condition)) {\n          // Store custom parameters if they exist\n          if (condition.customParameters) {\n            window.branchCustomParameters = condition.customParameters;\n          }\n          return condition.nextTrialId;\n        }\n      }\n      \n      // No condition matched - do NOT branch (conditions were defined but none matched)\n      return null;\n    };\n\n    const jsPsych = initJsPsych({\n      display_element: document.getElementById('jspsych-container'),\n\n      on_trial_start: function(trial) {\n        const lastTrialData = jsPsych.data.get()\n        if (lastTrialData && trial.data) {\n        trial.data.prev_response = lastTrialData.response;\n        }\n      },\n\n      \n\n      on_data_update: function (data) {\n\n        // Actualizar estado a 'in-progress' en la primera actualización\n        if (data.trial_index === 0) {\n          sessionRef.update({\n            state: 'in-progress',\n            lastUpdate: window.firebase.database.ServerValue.TIMESTAMP\n          }).catch(err => console.error('Error updating state:', err));\n          \n          // Actualizar también en db.json local\n          fetch('/api/save-online-session-metadata/e91d3b90-bfa6-4f83-9f69-72a1723948d2', {\n            method: 'POST',\n            headers: { 'Content-Type': 'application/json' },\n            body: JSON.stringify({\n              sessionId: trialSessionId,\n              state: 'in-progress'\n            })\n          }).catch(err => console.warn('Could not update state in local db:', err));\n        }\n\n        fetch(\"http://localhost:5001/test-e4cf9/us-central1/apiData\", {\n          method: \"POST\",\n          headers: { \"Content-Type\": \"application/json\", Accept: \"*/*\" },\n          body: JSON.stringify({\n            experimentID: \"e91d3b90-bfa6-4f83-9f69-72a1723948d2\",\n            sessionId: trialSessionId,\n            data: data,\n            storage: \"drive\",\n          }),\n        })\n        .then(res => {\n          if (!res.ok) {\n            return res.text().then(text => {\n              console.error('Error appending data:', text);\n            });\n          }\n          return res.json();\n        })\n        .then(result => {\n          if (result && result.success) {\n            console.log('Data appended to temporary storage');\n          }\n        })\n        .catch(error => {\n          console.error('Error in on_data_update:', error);\n        });\n\n        // Solo evaluar branching si el trial/loop tiene un trial_id o loop_id válido\n      if ((!data.trial_id || data.trial_id === undefined) && (!data.loop_id || data.loop_id === undefined)) {\n        return;\n      }\n      \n      const lastTrialData = jsPsych.data.getLastTrialData();\n      const trial = lastTrialData.trials ? lastTrialData.trials[0] : null;\n      \n      // Verificar si este trial/loop tiene branches\n      if (!trial || !trial.branches || trial.branches.length === 0) {\n        return; // No tiene branches, no hay nada que hacer\n      }\n      \n      // IMPORTANTE: Si el trial está dentro de un loop (isInLoop = true),\n      // NO activar el branching global. Los trials dentro de loops usan su propio\n      // sistema de branching con variables locales (loopNextTrialId, etc.)\n      if (trial.isInLoop === true) {\n        return;\n      }\n      \n      const nextTrialId = getNextTrialId(lastTrialData);\n      \n      if (nextTrialId) {\n        // Check if nextTrialId is \"FINISH_EXPERIMENT\"\n        if (nextTrialId === 'FINISH_EXPERIMENT') {\n          jsPsych.abortExperiment('Experiment finished by branching condition', {});\n          return;\n        }\n        \n        window.nextTrialId = nextTrialId;\n        window.skipRemaining = true;\n        window.branchingActive = true;\n      }\n      },\n\n      on_finish: async function() {\n        \n        // Cancelar el onDisconnect para evitar conflictos\n        sessionRef.onDisconnect().cancel();\n\n        // Finalizar la sesión normalmente y marcar en Firebase que terminó correctamente\n        console.log('Experiment finished normally, sending data to Google Drive...');\n        \n        try {\n          \n          // Marcar en Firebase que terminó correctamente Y necesita finalización\n          await sessionRef.update({\n            connected: false,\n            finished: true,\n            needsFinalization: true,\n            state: 'completed',\n            finishedAt: window.firebase.database.ServerValue.TIMESTAMP,\n            lastUpdate: window.firebase.database.ServerValue.TIMESTAMP\n          });\n          \n          // Guardar estado completado en db.json local (persistencia)\n          await fetch('/api/save-online-session-metadata/e91d3b90-bfa6-4f83-9f69-72a1723948d2', {\n            method: 'POST',\n            headers: { 'Content-Type': 'application/json' },\n            body: JSON.stringify({\n              sessionId: trialSessionId,\n              state: 'completed'\n            })\n          }).catch(err => console.warn('Could not update completed state in local db:', err));\n          \n          // El backend procesará la finalización al detectar needsFinalization=true\n          console.log('Session marked for finalization in Firebase');\n        } catch (error) {\n          console.error('Error marking session as finished:', error);\n        }\n      },\n  // Uncomment to see the json results after finishing a session experiment\n  // jsPsych.data.displayData('csv');\n});\n\nconst timeline = [];\n\n// Global preload for all uploaded files from Timeline\n\nconst globalPreload = {\n  type: jsPsychPreload,\n  files: [\"img/armadillo.png\",\"img/bmw.png\",\"img/boat.png\",\"img/boat2.png\",\"img/cofre.png\",\"img/cube.png\",\"img/dis.png\",\"img/floor.png\",\"img/green.png\",\"img/obstacle.png\",\"others/.DS_Store\"]\n};\ntimeline.push(globalPreload);\n\n\n\n    const test_stimuli_New_Trial = [{components: [{ type: \"ImageComponent\", coordinates: {\"x\":-0.14750896516393452,\"y\":-0.7063268442622951}, stimulus: \"img/armadillo.png\", rotation: 0 }],\nresponse_components: [{ type: \"ButtonResponseComponent\", coordinates: {\"x\":0.25,\"y\":0.8579234972677595}, width: 200, height: 50, choices: [\"qec\"] }],\nstimuli_duration: undefined,\ntrial_duration: undefined,\nresponse_ends_trial: undefined,\nresponses: [{ type: \"ButtonResponseComponent\", coordinates: {\"x\":0.25,\"y\":0.8579234972677595}, width: 200, height: 50, choices: [\"qec\"] }]}];\n    const New_Trial_timeline = {\n    type: DynamicPlugin, components: jsPsych.timelineVariable(\"components\"),\nresponse_components: jsPsych.timelineVariable(\"response_components\"),\nstimuli_duration: jsPsych.timelineVariable(\"stimuli_duration\"),\ntrial_duration: jsPsych.timelineVariable(\"trial_duration\"),\nresponse_ends_trial: jsPsych.timelineVariable(\"response_ends_trial\"),\n      data: {\n        stimulus: \"stimulus\",\nresponse: \"response\",\nrt: \"rt\",\n        trial_id: 1765473193557,\n        \n        \n      },\n    on_start: function(trial) {\n      // First, evaluate and apply params override conditions (if any)\n      \n      // Then apply custom parameters from branching conditions (higher priority)\n      \n      // For trials outside loops, use window.branchCustomParameters\n      if (window.branchCustomParameters && typeof window.branchCustomParameters === 'object') {\n        Object.entries(window.branchCustomParameters).forEach(([key, param]) => {\n          if (param && param.source !== 'none') {\n            // Parse key to check if it's a nested survey question\n            const parts = key.split('::');\n            \n            if (parts.length === 4) {\n              // Format: fieldType::componentName::survey_json::questionName\n              const [fieldType, componentName, propName, questionName] = parts;\n              \n              if (fieldType && componentName && propName === 'survey_json' && questionName) {\n                // Find the component by name in the field array\n                const fieldArray = trial[fieldType];\n                if (Array.isArray(fieldArray)) {\n                  const compIndex = fieldArray.findIndex(c => c.name === componentName);\n                  if (compIndex !== -1 && fieldArray[compIndex].survey_json) {\n                    // Find the question in survey_json.elements\n                    const elements = fieldArray[compIndex].survey_json.elements || [];\n                    const questionIndex = elements.findIndex(q => q.name === questionName);\n                    \n                    if (questionIndex !== -1) {\n                      // Apply the override value (from typed or csv)\n                      let valueToSet;\n                      if (param.source === 'typed') {\n                        valueToSet = String(param.value); // Convert to string for SurveyJS\n                      } else if (param.source === 'csv') {\n                        valueToSet = String(trial[param.value]); // Get from CSV column and convert to string\n                      }\n                      \n                      if (valueToSet !== undefined && valueToSet !== null) {\n                        fieldArray[compIndex].survey_json.elements[questionIndex].defaultValue = valueToSet;\n                      }\n                    }\n                  }\n                }\n              }\n            } else {\n              // Normal parameter (not nested survey question)\n              if (param.source === 'typed' && param.value !== undefined && param.value !== null) {\n                trial[key] = param.value;\n              } else if (param.source === 'csv' && param.value !== undefined && param.value !== null) {\n                trial[key] = trial[param.value];\n              }\n            }\n          }\n        });\n        // Clear the custom parameters after applying them\n        window.branchCustomParameters = null;\n      }\n      \n    },\n    \n    on_finish: function(data) {\n      // Este trial no tiene branches ni repeat conditions, es un trial terminal\n      // Si llegamos aquí después de un branching, terminar el experimento\n      if (window.branchingActive) {\n        jsPsych.abortExperiment('', {});\n      }\n    },\n    };\n    const New_Trial_procedure = {\n    timeline: \n    [New_Trial_timeline],\n    timeline_variables: test_stimuli_New_Trial,\n    conditional_function: function() {\n      const currentId = 1765473193557;\n      \n      // Verificar si hay un trial objetivo guardado en localStorage (para repeat/jump)\n      const jumpToTrial = localStorage.getItem('jsPsych_jumpToTrial');\n      if (jumpToTrial) {\n        if (String(currentId) === String(jumpToTrial)) {\n          // Encontramos el trial objetivo para repeat/jump\n          console.log('Repeat/jump: Found target trial', currentId);\n          localStorage.removeItem('jsPsych_jumpToTrial');\n          return true;\n        }\n        // No es el objetivo, saltar\n        console.log('Repeat/jump: Skipping trial', currentId);\n        return false;\n      }\n      \n      // Si skipRemaining está activo (branching normal), verificar si este es el trial objetivo\n      if (window.skipRemaining) {\n        if (String(currentId) === String(window.nextTrialId)) {\n          // Encontramos el trial objetivo\n          window.skipRemaining = false;\n          window.nextTrialId = null;\n          return true;\n        }\n        // No es el objetivo, saltar\n        return false;\n      }\n      \n      return true;\n    },\n    \n    };\n    timeline.push(New_Trial_procedure);\n  \n\njsPsych.run(timeline);\n\n})();\n"
      },
      "isDevMode": false,
      "createdAt": "2025-12-04T20:41:50.095Z",
      "updatedAt": "2025-12-11T19:01:37.498Z"
    }
  ],
  "pluginConfigs": [],
  "sessionResults": [
    {
      "experimentID": "e91d3b90-bfa6-4f83-9f69-72a1723948d2",
      "sessionId": "New Trial 1_result_974f390b-b599-479c-ab6f-84ebf8f16e78",
      "createdAt": "2025-12-11T16:44:34.855Z",
      "data": [
        {
          "stimulus": "stimulus",
          "response": "response",
          "rt": "rt",
          "trial_id": 1765465449246,
          "trial_type": "DynamicPlugin",
          "trial_index": 0,
          "plugin_version": "1.0.0",
          "time_elapsed": 1
        }
      ]
    },
    {
      "experimentID": "e91d3b90-bfa6-4f83-9f69-72a1723948d2",
      "sessionId": "New Trial 1_result_03304152-400f-497f-93df-df2fab9dfb28",
      "createdAt": "2025-12-11T17:10:23.053Z",
      "data": [
        {
          "stimulus": "stimulus",
          "response": "response",
          "rt": "rt",
          "trial_id": 1765465449246,
          "trial_type": "DynamicPlugin",
          "trial_index": 0,
          "plugin_version": "1.0.0",
          "time_elapsed": 4
        }
      ]
    },
    {
      "experimentID": "e91d3b90-bfa6-4f83-9f69-72a1723948d2",
      "sessionId": "New Trial 1_result_ad1a67ca-9ffa-4d98-bdde-1327c9dc39af",
      "createdAt": "2025-12-11T17:10:40.636Z",
      "data": [
        {
          "stimulus": "stimulus",
          "response": "response",
          "rt": "rt",
          "trial_id": 1765465449246,
          "trial_type": "DynamicPlugin",
          "trial_index": 0,
          "plugin_version": "1.0.0",
          "time_elapsed": 1
        }
      ]
    },
    {
      "experimentID": "e91d3b90-bfa6-4f83-9f69-72a1723948d2",
      "sessionId": "New Trial 1_result_669b1d73-ac0f-4115-90f4-9ad2786879e1",
      "createdAt": "2025-12-11T17:10:54.241Z",
      "data": [
        {
          "stimulus": "stimulus",
          "response": "response",
          "rt": "rt",
          "trial_id": 1765465449246,
          "trial_type": "DynamicPlugin",
          "trial_index": 0,
          "plugin_version": "1.0.0",
          "time_elapsed": 1
        }
      ]
    },
    {
      "experimentID": "e91d3b90-bfa6-4f83-9f69-72a1723948d2",
      "sessionId": "New Trial_result_98ecce99-0efe-416d-b337-45f2a4f88369",
      "createdAt": "2025-12-11T17:13:21.287Z",
      "data": [
        {
          "stimulus": "stimulus",
          "response": "response",
          "rt": "rt",
          "trial_id": 1765473193557,
          "trial_type": "DynamicPlugin",
          "trial_index": 0,
          "plugin_version": "1.0.0",
          "time_elapsed": 1
        }
      ]
    },
    {
      "experimentID": "e91d3b90-bfa6-4f83-9f69-72a1723948d2",
      "sessionId": "New Trial_result_ede077ac-eaf2-4ab7-9061-48fdea6289d0",
      "createdAt": "2025-12-11T17:15:50.258Z",
      "data": []
    },
    {
      "experimentID": "e91d3b90-bfa6-4f83-9f69-72a1723948d2",
      "sessionId": "New Trial_result_67baf9e6-ad47-418c-8e8f-ad2bb2a273c7",
      "createdAt": "2025-12-11T17:16:04.335Z",
      "data": [
        {
          "stimulus": [
            {
              "name": "ImageComponent_1",
              "type": "ImageComponent",
              "stimulus": "img/armadillo.png",
              "coordinates": {
                "x": 0.11888447745901654,
                "y": -0.7063268442622951
              }
            }
          ],
          "response": [
            {
              "name": "ButtonResponseComponent_1",
              "type": "ButtonResponseComponent",
              "response": "qec",
              "rt": 762
            }
          ],
          "rt": 763,
          "trial_id": 1765473193557,
          "trial_type": "DynamicPlugin",
          "trial_index": 0,
          "plugin_version": "1.0.0",
          "time_elapsed": 764
        }
      ]
    },
    {
      "experimentID": "e91d3b90-bfa6-4f83-9f69-72a1723948d2",
      "sessionId": "e2a2faf7-8d25-4218-8ac7-2823a3e68c2a",
      "createdAt": "2025-12-11T18:16:57.147Z",
      "data": [],
      "state": "completed",
      "lastUpdate": "2025-12-11T18:16:58.441Z",
      "metadata": {
        "browser": "Chrome",
        "browserVersion": "143.0",
        "os": "macOS",
        "screenWidth": 1440,
        "screenHeight": 900,
        "screenResolution": "1440x900",
        "viewportWidth": 1420,
        "viewportHeight": 762,
        "language": "en-US",
        "userAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/143.0.0.0 Safari/537.36",
        "startedAt": "2025-12-11T18:16:57.088Z"
      }
    },
    {
      "experimentID": "e91d3b90-bfa6-4f83-9f69-72a1723948d2",
      "sessionId": "aef72dbe-a0fd-43a2-8ec4-5007fb47b833",
      "createdAt": "2025-12-11T18:17:12.700Z",
      "data": [
        {
          "success": true,
          "timeout": false,
          "failed_images": [],
          "failed_audio": [],
          "failed_video": [],
          "trial_type": "preload",
          "trial_index": 0,
          "plugin_version": "2.1.0",
          "time_elapsed": 0
        }
      ],
      "state": "abandoned",
      "lastUpdate": "2025-12-11T18:17:13.454Z",
      "metadata": {
        "browser": "Chrome",
        "browserVersion": "143.0",
        "os": "macOS",
        "screenWidth": 1440,
        "screenHeight": 900,
        "screenResolution": "1440x900",
        "viewportWidth": 1420,
        "viewportHeight": 762,
        "language": "en-US",
        "userAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/143.0.0.0 Safari/537.36",
        "startedAt": "2025-12-11T18:17:12.646Z"
      }
    },
    {
      "experimentID": "e91d3b90-bfa6-4f83-9f69-72a1723948d2",
      "sessionId": "New Trial_result_a1766fcf-611e-4ad7-97d8-4d950669adac",
      "createdAt": "2025-12-11T18:38:54.561Z",
      "data": [],
      "state": "initiated",
      "lastUpdate": "2025-12-11T18:38:54.561Z",
      "metadata": {}
    },
    {
      "experimentID": "e91d3b90-bfa6-4f83-9f69-72a1723948d2",
      "sessionId": "New Trial_result_c5ffe840-048d-4f00-9abf-885ad081be06",
      "createdAt": "2025-12-11T18:39:09.769Z",
      "data": [],
      "state": "initiated",
      "lastUpdate": "2025-12-11T18:39:09.769Z",
      "metadata": {}
    },
    {
      "experimentID": "e91d3b90-bfa6-4f83-9f69-72a1723948d2",
      "sessionId": "New Trial_result_ee5b0a1d-7a25-4082-8932-22c0d22cd772",
      "createdAt": "2025-12-11T18:39:18.592Z",
      "data": [],
      "state": "initiated",
      "lastUpdate": "2025-12-11T18:39:18.592Z",
      "metadata": {}
    },
    {
      "experimentID": "e91d3b90-bfa6-4f83-9f69-72a1723948d2",
      "sessionId": "New Trial_result_6d836f89-da83-40cb-a8eb-d6f6538b160a",
      "createdAt": "2025-12-11T18:46:54.845Z",
      "data": [],
      "state": "initiated",
      "lastUpdate": "2025-12-11T18:46:54.846Z",
      "metadata": {}
    },
    {
      "experimentID": "e91d3b90-bfa6-4f83-9f69-72a1723948d2",
      "sessionId": "New Trial_result_706a756f-1bcf-4a54-91e5-365614585d37",
      "createdAt": "2025-12-11T18:51:16.362Z",
      "data": [],
      "state": "initiated",
      "lastUpdate": "2025-12-11T18:51:16.362Z",
      "metadata": {}
    }
  ]
}