<!DOCTYPE html><html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png+xml" href="/icon/fp black.png">
    <title>Experiment</title>

    <link href="../jspsych-bundle/index.css" rel="stylesheet" type="text/css">
    <script src="https://cdn.jsdelivr.net/gh/jspsych/jspsych@jspsych@7.0.0/examples/js/webgazer/webgazer.js"></script>

    <script src="../jspsych-bundle/index.js"></script>

    <style>
      body {
        margin: 0;
        padding: 0;
        background-color: #f0f0f0;
      }
      #jspsych-container {
        width: 100%;
        height: 100vh;
      }
      #jspsych-target {
        width: 100%;
      }
    </style>
  <style id="canvas-styles">
  body { background-color: #ffffff; }
  .jspsych-display-element { background-color: #ffffff; }
</style></head>
  <body>
    <div id="jspsych-container">
      <div id="jspsych-target"></div>
    </div>

    
  

<script id="generated-script">


        const trialSessionId =
            "numeros_result_" + (crypto.randomUUID
              ? crypto.randomUUID()
              : Math.random().toString(36).slice(2, 10));

        let participantNumber;

          async function saveSession(trialSessionId) {
          const res = await fetch("/api/append-result/5de9a3dd-867e-46d2-bed9-b0b461b56880", {
            method: "POST",
            headers: { "Content-Type": "application/json", Accept: "*/*" },
            body: JSON.stringify({
              sessionId: trialSessionId,
            }),
          });

          const result = await res.json();
          participantNumber = result.participantNumber;
          return participantNumber;
    }
(async () => {
localStorage.removeItem('jsPsych_jumpToTrial');
  participantNumber = await saveSession(trialSessionId);

  if (typeof participantNumber !== "number" || isNaN(participantNumber)) {
    alert("The participant number is not assigned. Please, wait.");
    throw new Error("participantNumber not assigned");
  }
    const jsPsych = initJsPsych({
    display_element: document.getElementById('jspsych-container'),
          on_data_update: function (data) {
            const res = fetch("/api/append-result/5de9a3dd-867e-46d2-bed9-b0b461b56880", {
              method: "PUT",
              headers: { "Content-Type": "application/json", Accept: "*/*" },
              body: JSON.stringify({
                sessionId: trialSessionId,
                response: data,
              }),
            });
        
          },

          on_finish: function() {
              jsPsych.data.displayData();
          },
    });

      const timeline = [];
      
      
    let test_stimuli_numeros = [];
    
    console.log("=== DEBUG numeros: Starting orders/categories logic ===");
    console.log("Trial name: numeros");
    console.log("Trial ID: 1771980159612");
    console.log("orders flag:", true);
    console.log("categories flag:", true);
    console.log("typeof participantNumber:", typeof participantNumber);
    console.log("participantNumber value:", participantNumber);
    console.log("isNaN(participantNumber):", isNaN(participantNumber));
    console.log("Condition check (typeof participantNumber === 'number' && !isNaN(participantNumber)):", (typeof participantNumber === "number" && !isNaN(participantNumber)));
    
    if (typeof participantNumber === "number" && !isNaN(participantNumber)) {
      console.log("‚úì INSIDE participantNumber check - condition passed");
      const stimuliOrders = [[9,8,7,6,5,4,3,2,1,0],[5,6,7,8,9,0,1,2,3,4]];
      const categoryData = ["non","par","non","par","non","par","non","par","non","par"];
      const test_stimuli_previous_numeros = [{components: [{ type: "TextComponent", coordinates: {"x":0,"y":0}, zIndex: 1, text: "1", font_color: "#000000", font_size: 16, font_family: "sans-serif", font_weight: "normal", font_style: "normal", text_align: "center", line_height: 1.5, background_color: "transparent", padding: "0px", border_radius: 0, border_color: "transparent", border_width: 0, name: "TextComponent_1" }],
response_components: [{ type: "ButtonResponseComponent", coordinates: {"x":1.6483516483516425,"y":-23.809523809523768}, zIndex: 2, choices: ["siguiente"], button_color: "#e7e7e7", button_text_color: "#000000", button_font_size: 14, button_border_radius: 3, button_border_color: "#999999", button_border_width: 1, button_padding: "6px 14px", name: "ButtonResponseComponent_1" }]},{components: [{ type: "TextComponent", coordinates: {"x":0,"y":0}, zIndex: 1, text: "2", font_color: "#000000", font_size: 16, font_family: "sans-serif", font_weight: "normal", font_style: "normal", text_align: "center", line_height: 1.5, background_color: "transparent", padding: "0px", border_radius: 0, border_color: "transparent", border_width: 0, name: "TextComponent_1" }],
response_components: [{ type: "ButtonResponseComponent", coordinates: {"x":1.6483516483516425,"y":-23.809523809523768}, zIndex: 2, choices: ["siguiente"], button_color: "#e7e7e7", button_text_color: "#000000", button_font_size: 14, button_border_radius: 3, button_border_color: "#999999", button_border_width: 1, button_padding: "6px 14px", name: "ButtonResponseComponent_1" }]},{components: [{ type: "TextComponent", coordinates: {"x":0,"y":0}, zIndex: 1, text: "3", font_color: "#000000", font_size: 16, font_family: "sans-serif", font_weight: "normal", font_style: "normal", text_align: "center", line_height: 1.5, background_color: "transparent", padding: "0px", border_radius: 0, border_color: "transparent", border_width: 0, name: "TextComponent_1" }],
response_components: [{ type: "ButtonResponseComponent", coordinates: {"x":1.6483516483516425,"y":-23.809523809523768}, zIndex: 2, choices: ["siguiente"], button_color: "#e7e7e7", button_text_color: "#000000", button_font_size: 14, button_border_radius: 3, button_border_color: "#999999", button_border_width: 1, button_padding: "6px 14px", name: "ButtonResponseComponent_1" }]},{components: [{ type: "TextComponent", coordinates: {"x":0,"y":0}, zIndex: 1, text: "4", font_color: "#000000", font_size: 16, font_family: "sans-serif", font_weight: "normal", font_style: "normal", text_align: "center", line_height: 1.5, background_color: "transparent", padding: "0px", border_radius: 0, border_color: "transparent", border_width: 0, name: "TextComponent_1" }],
response_components: [{ type: "ButtonResponseComponent", coordinates: {"x":1.6483516483516425,"y":-23.809523809523768}, zIndex: 2, choices: ["siguiente"], button_color: "#e7e7e7", button_text_color: "#000000", button_font_size: 14, button_border_radius: 3, button_border_color: "#999999", button_border_width: 1, button_padding: "6px 14px", name: "ButtonResponseComponent_1" }]},{components: [{ type: "TextComponent", coordinates: {"x":0,"y":0}, zIndex: 1, text: "5", font_color: "#000000", font_size: 16, font_family: "sans-serif", font_weight: "normal", font_style: "normal", text_align: "center", line_height: 1.5, background_color: "transparent", padding: "0px", border_radius: 0, border_color: "transparent", border_width: 0, name: "TextComponent_1" }],
response_components: [{ type: "ButtonResponseComponent", coordinates: {"x":1.6483516483516425,"y":-23.809523809523768}, zIndex: 2, choices: ["siguiente"], button_color: "#e7e7e7", button_text_color: "#000000", button_font_size: 14, button_border_radius: 3, button_border_color: "#999999", button_border_width: 1, button_padding: "6px 14px", name: "ButtonResponseComponent_1" }]},{components: [{ type: "TextComponent", coordinates: {"x":0,"y":0}, zIndex: 1, text: "6", font_color: "#000000", font_size: 16, font_family: "sans-serif", font_weight: "normal", font_style: "normal", text_align: "center", line_height: 1.5, background_color: "transparent", padding: "0px", border_radius: 0, border_color: "transparent", border_width: 0, name: "TextComponent_1" }],
response_components: [{ type: "ButtonResponseComponent", coordinates: {"x":1.6483516483516425,"y":-23.809523809523768}, zIndex: 2, choices: ["siguiente"], button_color: "#e7e7e7", button_text_color: "#000000", button_font_size: 14, button_border_radius: 3, button_border_color: "#999999", button_border_width: 1, button_padding: "6px 14px", name: "ButtonResponseComponent_1" }]},{components: [{ type: "TextComponent", coordinates: {"x":0,"y":0}, zIndex: 1, text: "7", font_color: "#000000", font_size: 16, font_family: "sans-serif", font_weight: "normal", font_style: "normal", text_align: "center", line_height: 1.5, background_color: "transparent", padding: "0px", border_radius: 0, border_color: "transparent", border_width: 0, name: "TextComponent_1" }],
response_components: [{ type: "ButtonResponseComponent", coordinates: {"x":1.6483516483516425,"y":-23.809523809523768}, zIndex: 2, choices: ["siguiente"], button_color: "#e7e7e7", button_text_color: "#000000", button_font_size: 14, button_border_radius: 3, button_border_color: "#999999", button_border_width: 1, button_padding: "6px 14px", name: "ButtonResponseComponent_1" }]},{components: [{ type: "TextComponent", coordinates: {"x":0,"y":0}, zIndex: 1, text: "8", font_color: "#000000", font_size: 16, font_family: "sans-serif", font_weight: "normal", font_style: "normal", text_align: "center", line_height: 1.5, background_color: "transparent", padding: "0px", border_radius: 0, border_color: "transparent", border_width: 0, name: "TextComponent_1" }],
response_components: [{ type: "ButtonResponseComponent", coordinates: {"x":1.6483516483516425,"y":-23.809523809523768}, zIndex: 2, choices: ["siguiente"], button_color: "#e7e7e7", button_text_color: "#000000", button_font_size: 14, button_border_radius: 3, button_border_color: "#999999", button_border_width: 1, button_padding: "6px 14px", name: "ButtonResponseComponent_1" }]},{components: [{ type: "TextComponent", coordinates: {"x":0,"y":0}, zIndex: 1, text: "9", font_color: "#000000", font_size: 16, font_family: "sans-serif", font_weight: "normal", font_style: "normal", text_align: "center", line_height: 1.5, background_color: "transparent", padding: "0px", border_radius: 0, border_color: "transparent", border_width: 0, name: "TextComponent_1" }],
response_components: [{ type: "ButtonResponseComponent", coordinates: {"x":1.6483516483516425,"y":-23.809523809523768}, zIndex: 2, choices: ["siguiente"], button_color: "#e7e7e7", button_text_color: "#000000", button_font_size: 14, button_border_radius: 3, button_border_color: "#999999", button_border_width: 1, button_padding: "6px 14px", name: "ButtonResponseComponent_1" }]},{components: [{ type: "TextComponent", coordinates: {"x":0,"y":0}, zIndex: 1, text: "10", font_color: "#000000", font_size: 16, font_family: "sans-serif", font_weight: "normal", font_style: "normal", text_align: "center", line_height: 1.5, background_color: "transparent", padding: "0px", border_radius: 0, border_color: "transparent", border_width: 0, name: "TextComponent_1" }],
response_components: [{ type: "ButtonResponseComponent", coordinates: {"x":1.6483516483516425,"y":-23.809523809523768}, zIndex: 2, choices: ["siguiente"], button_color: "#e7e7e7", button_text_color: "#000000", button_font_size: 14, button_border_radius: 3, button_border_color: "#999999", button_border_width: 1, button_padding: "6px 14px", name: "ButtonResponseComponent_1" }]}];
      
      console.log("participantNumber:", participantNumber);
      console.log("stimuliOrders:", stimuliOrders);
      console.log("stimuliOrders.length:", stimuliOrders.length);
      console.log("categoryData:", categoryData);
      console.log("categoryData.length:", categoryData.length);
      console.log("test_stimuli_previous_numeros.length:", test_stimuli_previous_numeros.length);
      
      if (categoryData.length > 0) {
        console.log("ENTERING categoryData.length > 0 branch");
        // Obtener todas las categor√≠as √∫nicas
        const allCategories = [...new Set(categoryData)];
        console.log("allCategories:", allCategories);
        
        // Determinar qu√© categor√≠a le corresponde a este participante
        const categoryIndex = (participantNumber - 1) % allCategories.length;
        const participantCategory = allCategories[categoryIndex];
        console.log("categoryIndex:", categoryIndex);
        console.log("participantCategory:", participantCategory);
        
        // Encontrar los √≠ndices que corresponden a esta categor√≠a
        const categoryIndices = [];
        categoryData.forEach((category, index) => {
          if (category === participantCategory) {
            categoryIndices.push(index);
          }
        });
        console.log("categoryIndices:", categoryIndices);
        
        // Filtrar los est√≠mulos por categor√≠a
        const categoryFilteredStimuli = categoryIndices.map(index => 
          test_stimuli_previous_numeros[index]
        );
        console.log("categoryFilteredStimuli.length:", categoryFilteredStimuli.length);

        // Aplicar el orden si existe
        if (stimuliOrders.length > 0) {
          console.log("ENTERING stimuliOrders.length > 0 sub-branch");
          const orderIndex = (participantNumber - 1) % stimuliOrders.length;
          const index_order = stimuliOrders[orderIndex];
          console.log("orderIndex:", orderIndex);
          console.log("index_order:", index_order);
          
          // Crear mapeo de √≠ndices originales a √≠ndices filtrados
          const indexMapping = {};
          categoryIndices.forEach((originalIndex, filteredIndex) => {
            indexMapping[originalIndex] = filteredIndex;
          });
          console.log("indexMapping:", indexMapping);
          
          // Aplicar el orden solo a los √≠ndices que existen en la categor√≠a filtrada
          const orderedIndices = index_order
            .filter(i => indexMapping.hasOwnProperty(i))
            .map(i => indexMapping[i]);
          console.log("orderedIndices:", orderedIndices);
          
          test_stimuli_numeros = orderedIndices
            .filter(i => i >= 0 && i < categoryFilteredStimuli.length)
            .map(i => categoryFilteredStimuli[i]);
        } else {
          console.log("ENTERING else (no orders) sub-branch");
          test_stimuli_numeros = categoryFilteredStimuli;
        }
        
        console.log("Participant:", participantNumber, "Category:", participantCategory);
        console.log("Category indices:", categoryIndices);
        console.log("Filtered stimuli:", test_stimuli_numeros);
        console.log("Final test_stimuli_numeros.length:", test_stimuli_numeros.length);
      } else if (stimuliOrders.length > 0) {
        console.log("ENTERING stimuliOrders.length > 0 branch (no categories)");
        // L√≥gica original sin categor√≠as pero con √≥rdenes
        const orderIndex = (participantNumber - 1) % stimuliOrders.length;
        const index_order = stimuliOrders[orderIndex];
        console.log("orderIndex:", orderIndex);
        console.log("index_order:", index_order);
        
        test_stimuli_numeros = index_order
          .filter((i) => i !== -1 && i >= 0 && i < test_stimuli_previous_numeros.length)
          .map((i) => test_stimuli_previous_numeros[i]);
          
        console.log(test_stimuli_numeros);
        console.log("Final test_stimuli_numeros.length:", test_stimuli_numeros.length);
      } else {
        console.log("ENTERING else branch (no categories, no orders)");
        // Sin categor√≠as ni √≥rdenes, usar todos los est√≠mulos
        test_stimuli_numeros = test_stimuli_previous_numeros;
        console.log("Final test_stimuli_numeros.length:", test_stimuli_numeros.length);
      }
    } else {
      console.log("‚úó FAILED participantNumber check");
      console.log("Reason: typeof participantNumber !== 'number' OR isNaN(participantNumber)");
      console.log("test_stimuli_numeros will be empty array!");
    }
    console.log("=== END DEBUG numeros ===");
    console.log("Final test_stimuli_numeros:", test_stimuli_numeros);
    console.log("Final test_stimuli_numeros.length:", test_stimuli_numeros.length);
    const numeros_timeline = {
    type: DynamicPlugin, components: jsPsych.timelineVariable("components"),
response_components: jsPsych.timelineVariable("response_components"),
      data: {
        rt: "rt",
        trial_id: 1771980159612,
        builder_id: 1771980159612,
        
        
      },
    on_start: function(trial) {
      // Then apply custom parameters from branching conditions (higher priority)
      // For trials outside loops, use window.branchCustomParameters
      if (window.branchCustomParameters && typeof window.branchCustomParameters === 'object') {
        Object.entries(window.branchCustomParameters).forEach(([key, param]) => {
          if (param && param.source !== 'none') {
            // Parse key to check if it's a nested survey question
            const parts = key.split('::');
            
            if (parts.length === 4) {
              // Format: fieldType::componentName::survey_json::questionName
              const [fieldType, componentName, propName, questionName] = parts;
              
              if (fieldType && componentName && propName === 'survey_json' && questionName) {
                // Find the component by name in the field array
                const fieldArray = trial[fieldType];
                if (Array.isArray(fieldArray)) {
                  const compIndex = fieldArray.findIndex(c => c.name === componentName);
                  if (compIndex !== -1 && fieldArray[compIndex].survey_json) {
                    // Find the question in survey_json.elements
                    const elements = fieldArray[compIndex].survey_json.elements || [];
                    const questionIndex = elements.findIndex(q => q.name === questionName);
                    
                    if (questionIndex !== -1) {
                      // Apply the override value (from typed or csv)
                      let valueToSet;
                      if (param.source === 'typed') {
                        valueToSet = String(param.value); // Convert to string for SurveyJS
                      } else if (param.source === 'csv') {
                        valueToSet = String(trial[param.value]); // Get from CSV column and convert to string
                      }
                      
                      if (valueToSet !== undefined && valueToSet !== null) {
                        fieldArray[compIndex].survey_json.elements[questionIndex].defaultValue = valueToSet;
                      }
                    }
                  }
                }
              }
            } else if (parts.length === 3) {
              // Format: fieldType::componentName::property (for DynamicPlugin components)
              const [fieldType, componentName, propName] = parts;
              
              if (fieldType && componentName && propName) {
                // Find the component by name in the field array
                const fieldArray = trial[fieldType];
                if (Array.isArray(fieldArray)) {
                  const compIndex = fieldArray.findIndex(c => c.name === componentName);
                  if (compIndex !== -1) {
                    // Apply the override value (from typed or csv)
                    let valueToSet;
                    if (param.source === 'typed') {
                      valueToSet = param.value;
                    } else if (param.source === 'csv') {
                      valueToSet = trial[param.value];
                    }
                    
                    if (valueToSet !== undefined && valueToSet !== null) {
                      fieldArray[compIndex][propName] = valueToSet;
                    }
                  }
                }
              }
            } else {
              // Normal parameter (not nested survey question)
              if (param.source === 'typed' && param.value !== undefined && param.value !== null) {
                trial[key] = param.value;
              } else if (param.source === 'csv' && param.value !== undefined && param.value !== null) {
                trial[key] = trial[param.value];
              }
            }
          }
        });
        // Clear the custom parameters after applying them
        window.branchCustomParameters = null;
      }
      
    },
    on_finish: function(data) {
      // Trial terminal - si llegamos aqu√≠ despu√©s de branching, terminar el experimento
      if (window.branchingActive) {
        jsPsych.abortExperiment('', {});
      }
    },};
    console.log("=== PROCEDURE SETUP numeros ===");
    console.log("test_stimuli_numeros before procedure:", test_stimuli_numeros);
    console.log("test_stimuli_numeros.length:", test_stimuli_numeros ? test_stimuli_numeros.length : 'undefined');
    
    const numeros_procedure = {
    timeline: 
    [numeros_timeline],
    timeline_variables: test_stimuli_numeros,
    
    conditional_function: function() {
      const currentId = 1771980159612;
      
      // Verificar si hay un trial objetivo guardado en localStorage (para repeat/jump)
      const jumpToTrial = localStorage.getItem('jsPsych_jumpToTrial');
      if (jumpToTrial) {
        if (String(currentId) === String(jumpToTrial)) {
          // Encontramos el trial objetivo para repeat/jump
          console.log('üîÅ [REPEAT/JUMP] Found target trial', currentId);
          localStorage.removeItem('jsPsych_jumpToTrial');
          return true;
        }
        // No es el objetivo, saltar
        console.log('‚è≠Ô∏è [REPEAT/JUMP] Skipping trial', currentId);
        return false;
      }
      
      // Si skipRemaining est√° activo (branching normal), verificar si este es el trial objetivo
      if (window.skipRemaining) {
        console.log('üîç [SKIP CHECK] Trial', currentId, '| Target:', window.nextTrialId, '| Match:', String(currentId) === String(window.nextTrialId));
        if (String(currentId) === String(window.nextTrialId)) {
          // Encontramos el trial objetivo
          console.log('‚úÖ [SKIP CHECK] Found target trial! Disabling skip mode');
          window.skipRemaining = false;
          window.nextTrialId = null;
          return true;
        }
        // No es el objetivo, saltar
        console.log('‚è≠Ô∏è [SKIP CHECK] Skipping trial', currentId);
        return false;
      }
      
      return true;
    },
  
    
    };
    timeline.push(numeros_procedure);
  

      jsPsych.run(timeline);
      
      })()
      
</script></body></html>